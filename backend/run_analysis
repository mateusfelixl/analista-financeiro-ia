# --- crew_service.py ---
import os
import traceback
from dotenv import load_dotenv
from datetime import datetime
from zoneinfo import ZoneInfo 

# Importa√ß√µes do CrewAI
from crewai import Agent, Task, Crew, Process
from crewai_tools import SerperDevTool
from langchain_litellm import ChatLiteLLM

class FinancialCrewService:
    
    def __init__(self):
        """
        O Construtor: Chamado APENAS UMA VEZ quando o servidor liga.
        """
        print("--- Inicializando o FinancialCrewService ---")
        load_dotenv(override=True)
        
        google_api_key = os.getenv("GOOGLE_API_KEY")
        serper_api_key = os.getenv("SERPER_API_KEY")
        
        if not google_api_key or not serper_api_key:
            raise ValueError("API Keys (GOOGLE/SERPER) n√£o encontradas no .env")

        # --- 1. Configura o LLM (UMA VEZ) ---
        self.llm = ChatLiteLLM(
            model="gemini/gemini-2.5-flash",
            temperature=0.5
        )

        # --- 2. Configura a Ferramenta (UMA VEZ) ---
        self.search_tool = SerperDevTool(num_results=4, api_key=serper_api_key)
        
        # --- 3. Define os Agentes "Molde" (UMA VEZ) ---
        # Note que o 'goal' e 'description' ser√£o atualizados no 'run'
        
        self.julia_agent = Agent(
            role='Analista Quantitativa S√™nior (Quant)',
            backstory='Uma especialista em dados de Wall Street. C√©tica, odeia "achismos" e s√≥ confia em n√∫meros.',
            tools=[self.search_tool],
            llm=self.llm,
            verbose=True
        )
        
        self.pedro_agent = Agent(
            role='Investigador de M√≠dia e Sentimento',
            backstory='Um ex-jornalista investigativo que l√™ nas entrelinhas das not√≠cias para descobrir o sentimento real do mercado.',
            tools=[self.search_tool],
            llm=self.llm,
            verbose=True
        )
        
        self.key_agent = Agent(
            role='Redatora-Chefe de An√°lise Financeira',
            backstory='Uma jornalista financeira experiente com 20 anos de casa. Traduz dados complexos em recomenda√ß√µes claras.',
            llm=self.llm,
            verbose=True
        )
        print("--- Servi√ßo de IA pronto para operar ---")

    def _get_current_date(self):
        """ M√©todo privado para pegar a data formatada """
        try:
            fuso_horario_sp = ZoneInfo("America/Sao_Paulo")
            return datetime.now(fuso_horario_sp).strftime("%d/%m/%Y")
        except Exception:
            print("Aviso: Falha ao carregar fuso 'America/Sao_Paulo'. Usando data UTC.")
            return datetime.now().strftime("%d/%m/%Y")

    def run_analysis(self, stock_symbol: str) -> dict:
        """
        Este m√©todo √© chamado a CADA requisi√ß√£o de API.
        Ele REUTILIZA os agentes e ferramentas j√° criados.
        """
        print(f"--- EXECUTANDO CREW (v3.0) PARA {stock_symbol} ---")
        data_atual = self._get_current_date()
        
        # --- Atualiza os objetivos dos agentes para esta a√ß√£o espec√≠fica ---
        self.julia_agent.goal = f'Extrair dados financeiros frios e brutos para {stock_symbol}, focando em P/L, ROE e receita trimestral.'
        self.pedro_agent.goal = f'Descobrir o "hype" e o sentimento qualitativo (Bullish ou Bearish) do mercado sobre {stock_symbol}.'
        self.key_agent.goal = f'Combinar os dados "frios" (J√∫lia) e "quentes" (Pedro) em um relat√≥rio final coeso para {stock_symbol}.'

        # --- Defini√ß√£o das TAREFAS (elas mudam a cada chamada) ---
        task_julia = Task(
            description=f'Busque os seguintes dados para {stock_symbol}: 1. Cota√ß√£o atual. 2. P/L. 3. ROE. 4. Receita do √∫ltimo trimestre. 5. Lucro L√≠quido do √∫ltimo trimestre.',
            agent=self.julia_agent,
            expected_output='Um resumo em "bullet points" contendo apenas os dados num√©ricos solicitados.'
        )
        task_pedro = Task(
            description=f'Analise as 3 not√≠cias mais recentes e o sentimento geral do mercado para {stock_symbol}. O sentimento √© Positivo (Bullish), Negativo (Bearish) ou Neutro?',
            agent=self.pedro_agent,
            expected_output='Um par√°grafo resumindo o sentimento geral e as not√≠cias que o causam.',
            context=[task_julia]
        )
        task_key = Task(
            description=f'''
            Use os dados financeiros da Tarefa 1 e a an√°lise de sentimento da Tarefa 2.
            Escreva um relat√≥rio profissional em Portugu√™s (Markdown) sobre {stock_symbol}.
            O relat√≥rio DEVE incluir a data de hoje: {data_atual}
            Estrutura: # T√≠tulo, **Data:** {data_atual}, ## Resumo dos Dados, ## An√°lise de Sentimento, ## Recomenda√ß√£o (COMPRAR, VENDER ou MANTER) com "Justificativa:".
            N√ÉO inclua "Editor-Chefe" ou "Autor".
            ''',
            agent=self.key_agent,
            expected_output='O relat√≥rio final completo em Portugu√™s, formato Markdown, com a data de hoje.',
            context=[task_julia, task_pedro]
        )

        # --- Montagem e Execu√ß√£o do Crew ---
        stock_crew = Crew(
            agents=[self.julia_agent, self.pedro_agent, self.key_agent],
            tasks=[task_julia, task_pedro, task_key],
            process=Process.sequential,
            memory=False,
            verbose=True
        )
        
        resultado_final = stock_crew.kickoff()
        print(f"--- EXECU√á√ÉO CONCLU√çDA PARA {stock_symbol} ---")

        resultado_julia = task_julia.output.raw if task_julia.output else "Dados de J√∫lia n√£o coletados."
        resultado_pedro = task_pedro.output.raw if task_pedro.output else "Sentimento de Pedro n√£o analisado."

        return {
            "message": str(resultado_final) if resultado_final else "An√°lise n√£o conclu√≠da.",
            "dados": str(resultado_julia),
            "sentimento": str(resultado_pedro),
            "status": "success"
        }

# --- Singleton Pattern ---
# Cria UMA √öNICA inst√¢ncia do servi√ßo para ser usada em todo o app.
# O Python executa este c√≥digo quando o arquivo √© importado pela primeira vez.
try:
    crew_service = FinancialCrewService()
except Exception as e:
    print(f"--- üõë FALHA CR√çTICA AO INICIAR O CREW_SERVICE üõë ---")
    print(str(e))
    traceback.print_exc()
    crew_service = None # Deixa o app subir, mas o endpoint vai falhar